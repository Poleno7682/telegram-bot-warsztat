# Отчет по аудиту и план рефакторинга

## 1. Краткое резюме состояния проекта
- **Стек**: Python 3.12.10, aiogram 3.22, SQLAlchemy 2.0, Alembic, asyncpg/aiosqlite, pydantic v2, deep-translator.
- **Назначение**: Telegram-бот для записи в автосервис, с меню администратора/механика, напоминаниями и мультиязычной поддержкой (PL/RU).
- **Главные модули**: `app/bot/handlers`, `app/services`, `app/repositories`, `app/config`.

## 2. Соответствие SOLID
| Принцип | Оценка | Наблюдения |
| --- | --- | --- |
| SRP | ⚠️ | `admin.py` (≈700 строк) объединяет управление пользователями, механиками, услугами и настройками. Нет выделенного сервиса для переводов, напоминаний и т.п. |
| OCP | ⚠️ | Добавление нового языка требует правок в нескольких местах (хардкод списков). Нет конфигурационного слоя для расширения функциональности. |
| LSP | ✔️ | Наследование используется ограниченно, явных нарушений не найдено. |
| ISP | ⚠️ | Сервисы и репозитории предоставляют крупные интерфейсы, а клиентам приходится тянуть весь функционал. Нет мелких контрактов. |
| DIP | ⚠️ | Хэндлеры напрямую создают репозитории/сервисы; отсутствует слой абстракции или DI-контейнер. |

## 3. Риски утечек памяти, зависаний и падений
1. **Неограниченный кеш переводов** `TranslationService._cache`: рост ОЗУ при активном вводе нового текста.
2. **Планировщик напоминаний**:
   - Каждую минуту загружает все подтверждённые записи в окне без фильтра по флагам `reminder_*_sent`.
   - Нет гарантий остановки таска при исключениях на старте.
3. **Автовозврат в меню**: каждая «тупиковая» операция порождает `asyncio.create_task` без отслеживания → лавина фоновых задач и повторные сообщения «Меню».
4. **Часовые пояса**: данные о бронированиях могут храниться не в UTC; напоминания сравнивают с `datetime.now(timezone.utc)`, что грозит ранним/поздним уведомлением.
5. **Зависимости**: `aiogram-dialog`, `aiofiles`, `structlog` установлены, но не используются — увеличивают поверхность атаки и размер окружения.

## 4. Соответствие актуальной документации
Через Context7 проверены официальные источники (Python, aiogram 3.22, aiogram-dialog, SQLAlchemy 2.0, Alembic, asyncpg, aiosqlite, deep-translator, googletrans, pydantic/pydantic-settings, python-dotenv, pytz, python-dateutil, aiofiles, structlog). Код в целом соответствует актуальным API:
- `Bot(default=DefaultBotProperties(...))` — корректно для aiogram ≥3.7.
- SQLAlchemy 2.0: используется `mapped_column`, `select` с `async_session`.
- Alembic: миграции созданы; новая миграция добавляет флаги напоминаний.
- Pydantic 2.x: `SettingsConfigDict` и `.model_config`.
- asyncpg пока не задействован (подготовлено в requirements, но фактический движок по умолчанию SQLite).

## 5. Оптимизация для 24/7 VPS
- Нужен `systemd` юнит с обработкой `ExecStartPre`/`ExecStopPost` (запрос пользователя закрывать процессы Python).
- Перевод БД на PostgreSQL (asyncpg) для многопоточности и напоминаний.
- Включение `structlog` (JSON-логи) + `logrotate`.
- Ограничение пулов SQLAlchemy, ThreadPoolExecutor для переводов, rate limit для отправки уведомлений.
- Heartbeat/health-check (метрика или `/healthz`) для контроля фоновых задач.

## 6. Шаги по снижению рисков
1. Ограниченный кеш переводов: LRU или Redis, добавление TTL, очистка при старте.
2. Scheduler:
   - SQL-фильтры по `reminder_*_sent`, индексы на `booking_date`.
   - Контекстный менеджер/служба, гарантирующая остановку при исключениях.
   - Перевод дат в UTC при записи.
3. Меню: централизованный диспетчер отложенных сообщений (дедупликация по chat_id).
4. Удаление/использование лишних зависимостей.
5. Разделение handler-модулей и введение сервисного слоя.

## 7. Пошаговый план рефакторинга
1. **Структуризация модулей**
   - Разбить `bot/handlers/admin.py` на подмодули (`users.py`, `mechanics.py`, `services.py`, `settings.py`).
   - Создать слой сервисов (например, `services/user_management.py`), чтобы handler-ы вызывали высокоуровневые методы.

2. **Конфигурация и DI**
   - Ввести фабрику объектов (простая функция/класс), которая выдаёт репозитории/сервисы, вместо создания их в каждом handler-е.
   - Вынести список поддерживаемых языков в `Settings` или отдельный конфиг; использовать его при генерации клавиатур и переводов.

3. **Работа с переводами**
   - Переписать `TranslationService` на класс с настраиваемым backend и ограниченным кешем (LRUCache или Redis).
   - Добавить обработку таймаутов и fallback на ручной ввод.

4. **Напоминания**
   - Добавить индексы и фильтры в `BookingRepository.get_bookings_for_reminders`.
   - Хранить `booking_date` строго в UTC; конвертировать при вводе.
   - Оборачивать `ReminderScheduler` в контекст, чтобы гарантировать `stop()` при любых ошибках.
   - Рассмотреть вынос планировщика в отдельный процесс (Celery/APScheduler) для независимости от бота.

5. **Меню и UX**
   - Реализовать менеджер отложенных задач, чтобы сообщения главного меню отправлялись раз в X секунд на чат, а не на каждую операцию.
   - Добавить троттлинг/дедупликацию Telegram-уведомлений.

6. **Логирование и наблюдаемость**
   - Настроить `structlog` (JSON + contextvars) и логгировать ключевые события (создание записи, напоминание, ошибки перевода).
   - Добавить метрики (счётчики напоминаний, переведённых услуг).

7. **Инфраструктура**
   - Подготовить `systemd`-юнит и инструкцию по установке на VPS (включая `logrotate`, резервное копирование БД).
   - Завести `.env.example`, README с шагами деплоя, указанием требований (CPU/RAM/SSD).

8. **Тестирование**
   - Написать модульные тесты для ключевых сервисов (переводы, scheduler, обработчики FSM).
   - Добавить интеграционные тесты миграций (`alembic upgrade --sql`).

Реализация плана снизит риски утечек и зависаний, улучшит поддержку SOLID и подготовит проект к стабильной работе 24/7 на Linux VPS. 

