# План рефакторинга (шаги и статус)

Обновляй чекбоксы после завершения соответствующего шага. Каждый шаг = отдельный git-коммит.

## 1. Структуризация модулей и слой сервисов
- [x] 1.1 Разбить `backend/app/bot/handlers/admin.py` на отдельные файлы (`users.py`, `mechanics.py`, `services.py`, `settings.py`) с регистрацией в `handlers/__init__.py`.
- [x] 1.2 Создать сервисный слой (`backend/app/services/service_management_service.py`, `settings_management_service.py`) и перевести хэндлеры на использование сервисов вместо прямых репозиториев.

## 2. Конфигурация и DI
- [x] 2.1 Вынести список поддерживаемых языков в конфиг (`Settings` или отдельный модуль) и использовать его во всех клавиатурах/переводах.
- [x] 2.2 Добавить простую фабрику/контейнер для выдачи репозиториев/сервисов в хэндлеры (чтобы не создавать объекты вручную в каждом handler).

## 3. Работа с переводами
- [x] 3.1 Переписать `TranslationService` на класс с ограниченным кешем (LRU или Redis) и стратегией fallback.
- [x] 3.2 Добавить обработку таймаутов/исключений и конфигурируемый список целевых языков.

## 4. Напоминания и хранение времени
- [x] 4.1 Убедиться, что все `booking_date` сохраняются в UTC: преобразование при вводе + миграция/валидация данных.
- [x] 4.2 Оптимизировать `get_bookings_for_reminders`: SQL-фильтр по `reminder_*_sent`, индексы на `booking_date`, лимит выборки.
- [x] 4.3 Обернуть `ReminderScheduler` в контекстный менеджер/службу с гарантированным `stop()` и обработкой сбоев.

## 5. UX и меню
- [x] 5.1 Реализовать менеджер отложенных сообщений (дедупликация отправки главного меню на чат).
- [x] 5.2 Добавить троттлинг для сервисных уведомлений (например, при ошибках перевода).

## 6. Логирование и наблюдаемость
- [ ] 6.1 Настроить `structlog` (JSON-формат, contextvars), заменить текущие `print`/logging-вызовы.
- [ ] 6.2 Добавить базовые метрики (счётчики напоминаний, переводов) и health-check команду.

## 7. Инфраструктура
- [ ] 7.1 Подготовить `systemd` unit + `logrotate` конфиг + инструкции для VPS (в README).
- [ ] 7.2 Обновить документацию (.env.example, шаги деплоя, требования к серверу).

## 8. Тестирование
- [ ] 8.1 Добавить модульные тесты для новых сервисов/переводов/напоминаний.
- [ ] 8.2 Автоматизировать проверку миграций (скрипт или CI-шаг `alembic upgrade --sql`).

> Всего шагов: 16. Отмечай выполненные галочкой и коммитами.

